<!DOCTYPE html><html lang="zh-TW"><head><meta charset="utf-8"><title>MERN å°ˆæ¡ˆSTEP | HenRsã®å°çª©</title><meta name="author" content="HenRs"><meta name="description" content="æœ‰é—œæ–¼ã€æˆ‘ã€"><meta name="keywords" content=""><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><link rel="icon" href="/images/avatar.webp"><link rel="preconnect" href="https://s4.zstatic.net"><script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"><link rel="preconnect" href="https://fonts.googleapis.cn"><link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin><link rel="stylesheet" href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"><script>const mixins={}</script><script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script><script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script><script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script><link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"><script src="/js/lib/highlight.js"></script><script src="/js/lib/preview.js"></script><link rel="stylesheet" href="/css/main.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="layout"><transition name="fade"><div id="loading" v-show="loading"><div id="loading-circle"><h2>LOADING</h2><p>åŠ è¼‰ä¸­Â·Â·Â·è«‹ç¨å¾Œï¼Œå¦‚éæ…¢è«‹æ¸…ç†ç·©å­˜</p><img src="/images/loading.gif"></div></div></transition><div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}"><nav id="desktop-menu"><a class="title" href="/"><span>HENRSã®å°çª©</span> </a><a href="/"><i class="fa-solid fa-house fa-fw"></i> <span>&ensp;é¦–é </span> </a><a href="/about"><i class="fa-solid fa-id-card fa-fw"></i> <span>&ensp;é—œæ–¼</span> </a><a href="/archives"><i class="fa-solid fa-box-archive fa-fw"></i> <span>&ensp;é …ç›®</span> </a><a href="/categories"><i class="fa-solid fa-bookmark fa-fw"></i> <span>&ensp;é¡åˆ¥</span> </a><a href="/tags"><i class="fa-solid fa-tags fa-fw"></i> <span>&ensp;æ¨™ç±¤</span></a></nav><nav id="mobile-menu"><div class="title" @click="showMenuItems = !showMenuItems"><i class="fa-solid fa-bars fa-fw"></i> <span>&emsp;HENRSã®å°çª©</span></div><transition name="slide"><div class="items" v-show="showMenuItems"><a href="/"><div class="item"><div style="min-width:20px;max-width:50px;width:10%"><i class="fa-solid fa-house fa-fw"></i></div><div style="min-width:100px;max-width:150%;width:20%">é¦–é </div></div></a><a href="/about"><div class="item"><div style="min-width:20px;max-width:50px;width:10%"><i class="fa-solid fa-id-card fa-fw"></i></div><div style="min-width:100px;max-width:150%;width:20%">é—œæ–¼</div></div></a><a href="/archives"><div class="item"><div style="min-width:20px;max-width:50px;width:10%"><i class="fa-solid fa-box-archive fa-fw"></i></div><div style="min-width:100px;max-width:150%;width:20%">é …ç›®</div></div></a><a href="/categories"><div class="item"><div style="min-width:20px;max-width:50px;width:10%"><i class="fa-solid fa-bookmark fa-fw"></i></div><div style="min-width:100px;max-width:150%;width:20%">é¡åˆ¥</div></div></a><a href="/tags"><div class="item"><div style="min-width:20px;max-width:50px;width:10%"><i class="fa-solid fa-tags fa-fw"></i></div><div style="min-width:100px;max-width:150%;width:20%">æ¨™ç±¤</div></div></a></div></transition></nav></div><transition name="fade"><div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div></transition><div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'"><div class="article"><div><h1>MERN å°ˆæ¡ˆSTEP</h1></div><div class="info"><span class="date"><span class="icon"><i class="fa-solid fa-calendar fa-fw"></i> </span>2024/8/24 </span><span class="category"><a href="/categories/%E6%95%99%E7%A8%8B/"><span class="icon"><i class="fa-solid fa-bookmark fa-fw"></i> </span>æ•™ç¨‹ </a></span><span class="tags"><span class="icon"><i class="fa-solid fa-tags fa-fw"></i> </span><span class="tag"><a href="/tags/MERN/" style="color:#03a9f4">MERN </a></span><span class="tag"><a href="/tags/MongoDB/" style="color:#ff7d73">MongoDB </a></span><span class="tag"><a href="/tags/Express/" style="color:#ffa2c4">Express </a></span><span class="tag"><a href="/tags/React/" style="color:#00a596">React </a></span><span class="tag"><a href="/tags/Node-js/" style="color:#ffa2c4">Node.js </a></span><span class="tag"><a href="/tags/%E5%85%A8%E7%AB%AF%E9%96%8B%E7%99%BC/" style="color:#00a596">å…¨ç«¯é–‹ç™¼</a></span></span></div><div class="content" v-pre><h2 id="ä»€éº¼æ˜¯-mern-stack"><a class="markdownIt-Anchor" href="#ä»€éº¼æ˜¯-mern-stack"></a> ä»€éº¼æ˜¯ MERN Stackï¼Ÿ</h2><p>MERN ä»£è¡¨ <strong>MongoDB, Express, React, Node.js</strong>ï¼Œæ˜¯ä¸€å¥—å¼·å¤§çš„å…¨ç«¯é–‹ç™¼æŠ€è¡“æ£§ï¼Œè®“é–‹ç™¼è€…èƒ½å¤ ä»¥ <strong>JavaScript</strong> æ‰“é€ å¾å¾Œç«¯åˆ°å‰ç«¯çš„å®Œæ•´æ‡‰ç”¨ç¨‹å¼ã€‚</p><ul><li><strong>MongoDB</strong>: NoSQL è³‡æ–™åº«ï¼Œé©åˆå„²å­˜ JSON æ ¼å¼çš„æ–‡ä»¶å‹è³‡æ–™ã€‚</li><li><strong>Express</strong>: Node.js ä¸Šçš„è¼•é‡æ¡†æ¶ï¼Œæä¾›å¾Œç«¯ API å’Œä¸­ä»‹è»Ÿé«”åŠŸèƒ½ã€‚</li><li><strong>React</strong>: ç”¨æ–¼å»ºæ§‹å‰ç«¯ç”¨æˆ¶ç•Œé¢ (UI) çš„ JavaScript å‡½å¼åº«ã€‚</li><li><strong>Node.js</strong>: æä¾›å¾Œç«¯é‹è¡Œç’°å¢ƒï¼Œå¯åŸ·è¡Œ JavaScript ç¨‹å¼ç¢¼ã€‚</li></ul><span id="more"></span><hr><h2 id="mern-å°ˆæ¡ˆæ¶æ§‹æ¦‚è¦½"><a class="markdownIt-Anchor" href="#mern-å°ˆæ¡ˆæ¶æ§‹æ¦‚è¦½"></a> MERN å°ˆæ¡ˆæ¶æ§‹æ¦‚è¦½</h2><p>ä¸€å€‹å…¸å‹çš„ MERN å°ˆæ¡ˆæœƒåŒ…å«ä»¥ä¸‹çµæ§‹ï¼š</p><pre class="highlight"><code class="text">my-mern-project/
â”œâ”€â”€ backend/ # å¾Œç«¯ç¨‹å¼ç¢¼
â”‚ â”œâ”€â”€ models/ # MongoDB è³‡æ–™æ¨¡å‹
â”‚ â”œâ”€â”€ routes/ # Express è·¯ç”±å’Œ API
â”‚ â””â”€â”€ server.js # Node.js ä¼ºæœå™¨å…¥å£
â”œâ”€â”€ frontend/ # å‰ç«¯ç¨‹å¼ç¢¼
â”‚ â”œâ”€â”€ src/
â”‚ â”‚ â”œâ”€â”€ components/ # React çµ„ä»¶
â”‚ â”‚ â”œâ”€â”€ pages/ # æ‡‰ç”¨ç¨‹å¼é é¢
â”‚ â”‚ â””â”€â”€ App.js # React æ‡‰ç”¨å…¥å£
â”œâ”€â”€ .env # ç’°å¢ƒè®Šæ•¸é…ç½®
â”œâ”€â”€ package.json # ä¾è³´èˆ‡è…³æœ¬è¨­å®š
â””â”€â”€ README.md # å°ˆæ¡ˆèªªæ˜æ–‡ä»¶
</code></pre><h2 id="å°ˆæ¡ˆæ­¥é©Ÿèˆ‡æ ¸å¿ƒåŠŸèƒ½"><a class="markdownIt-Anchor" href="#å°ˆæ¡ˆæ­¥é©Ÿèˆ‡æ ¸å¿ƒåŠŸèƒ½"></a> å°ˆæ¡ˆæ­¥é©Ÿèˆ‡æ ¸å¿ƒåŠŸèƒ½</h2><h3 id="1-åˆå§‹åŒ–å°ˆæ¡ˆ"><a class="markdownIt-Anchor" href="#1-åˆå§‹åŒ–å°ˆæ¡ˆ"></a> 1. åˆå§‹åŒ–å°ˆæ¡ˆ</h3><p>æ‰“é–‹ VS Code å…ˆåœ¨çµ‚ç«¯é‹è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼Œå¦‚æœªç‰¹åˆ¥è¨­ç½®å…¨éƒ½é»˜èªå³å¯</p><pre class="highlight"><code class="bash">npm init
npm install express dotenv bcrypt mongoose
</code></pre><h3 id="2-è¨­ç½®-mongodb-è³‡æ–™åº«"><a class="markdownIt-Anchor" href="#2-è¨­ç½®-mongodb-è³‡æ–™åº«"></a> 2. è¨­ç½® MongoDB è³‡æ–™åº«</h3><p>åœ¨æ ¹ç›®éŒ„å‰µå»º server.js ä¸¦è¨­ç½® MongoDB è³‡æ–™åº«ã€‚ä½ å¯ä»¥åœ¨ MongoDB Atlas æˆ–æœ¬åœ°ç«¯è¨­ç½®è³‡æ–™åº«ï¼Œä¸¦é€£çµåˆ°å°ˆæ¡ˆï¼š</p><pre class="highlight"><code class="js">const mongoose = require(&quot;mongoose&quot;);
//  mongodb://127.0.0.1:27017/ å‰é¢ç‚ºå›ºå®šæ ¼å¼ å¾Œç¶´çœ‹ä½ æƒ³é€£çµçš„è³‡æ–™åº«
mongoose
  .connect(&quot;mongodb://127.0.0.1:27017/MernDB&quot;)
  .then(() =&gt; console.log(&quot;MongoDB é€£ç·šæˆåŠŸ&quot;))
  .catch((err) =&gt; console.error(&quot;MongoDB é€£ç·šå¤±æ•—:&quot;, err));
</code></pre><h3 id="3-å»ºç«‹è³‡æ–™æ¨¡å‹"><a class="markdownIt-Anchor" href="#3-å»ºç«‹è³‡æ–™æ¨¡å‹"></a> 3. å»ºç«‹è³‡æ–™æ¨¡å‹</h3><p>æ–°å»ºä¸€å€‹è³‡æ–™å¤¾ä¸¦åœ¨å…¶ä¸­å»ºç«‹ User åŠå…¶ä»–è³‡æ–™çš„ç›¸é—œæ¨¡å‹ã€‚ä»¥ä¸‹æ˜¯åŸºç¤çš„ Schema æ¢ä»¶å»ºç½®ï¼š</p><pre class="highlight"><code class="js">const mongoose = require(&quot;mongoose&quot;);
const &#123; Schema &#125; = mongoose;

const userSchema = new Schema(&#123;
  username: &#123;
    type: String,
    required: true,
    minlength: [3, &quot;è«‹è‡³å°‘è¼¸å…¥ä¸‰å€‹å­—å…ƒ&quot;],
    maxlength: [12, &quot;è¶…å‡ºå­—æ•¸é™åˆ¶!!&quot;],
  &#125;,
  email: &#123;
    type: String,
    required: true,
    minlength: [5, &quot;è«‹è‡³å°‘è¼¸å…¥äº”å€‹å­—å…ƒ&quot;],
    maxlength: [25, &quot;è¶…å‡ºå­—å…ƒé™åˆ¶!!&quot;],
  &#125;,
  password: &#123;
    type: String,
    minlength: [8, &quot;Password must be at least 8 characters&quot;],
    maxlengeh: [15, &quot;Password must be less than 15 characters&quot;],
    validate: &#123;
      validator: function (v) &#123;
        // æª¢æŸ¥æ˜¯å¦åŒ…å«è‡³å°‘ä¸€å€‹å­—æ¯å’Œä¸€å€‹æ•¸å­—ï¼Œä½†å¾ŒçºŒæœƒé€é'JOI'é€™å€‹æ’ä»¶å¯¦ç¾ é€™é‚Šåªæ˜¯ç”¨æ–¼è¨˜æ†¶
        return /^(?=.*[A-Za-z])(?=.*\d)/.test(v);
      &#125;,
      message: &quot;Password must contain at least one letter and one number&quot;,
    &#125;,
  &#125;,
  role: &#123;
    type: String,
    required: true,
    enum: [&quot;Student&quot;, &quot;Instructor&quot;],
  &#125;,
  date: &#123;
    type: Date,
    default: Date.now,
  &#125;,
&#125;);
</code></pre><p>å»ºç«‹ mdoel çš„è¦å‰‡ä¸¦é€é bcrypt åŠ å¯†ï¼Œä¸¦åœ¨ save å‹•ä½œå‰è§¸ç™¼ï¼š</p><ul><li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/bcrypt">bcrypt</a></li></ul><pre class="highlight"><code class="js">const bcrypt = require(&quot;bcrypt&quot;);
const saltRounds = 14; //åŠ å¯†è¤‡é›œåº¦ å»ºè­°åœ¨10-14é–“ step = 2

userSchema.methods.isStudent = function () &#123;
  return this.role == &quot;Student&quot;; //ç„¡æ³•ç”¨ arrow fc æœƒæŠ“ä¸åˆ° this
&#125;;

userSchema.methods.isInstructor = function () &#123;
  return this.role == &quot;Instructor&quot;;
&#125;;

userSchema.methods.comparePassword = async function (password, cb) &#123;
  let result;
  try &#123;
    result = await bcrypt.compare(password, this.password);
    return cb(null, result);
  &#125; catch (e) &#123;
    return cb(e, result);
  &#125;
&#125;;

userSchema.pre(&quot;save&quot;, async function (next) &#123;
  //è¡¨ç¤ºåœ¨ save å‰è§¸ç™¼æ­¤ fc
  if (this.isNew || this.isModified(&quot;password&quot;)) &#123;
    //isNew ç¢ºèªæ˜¯å¦ç‚ºæ–°æ–‡æª” || isModified ç¢ºèªæ˜¯å¦ç¶“ä¿®æ”¹é å…©è€…ç‚º mongoose å…§å»ºå‡½æ•¸
    const hashedPass = await bcrypt.hash(this.password, saltRounds);
    this.password = hashedPass;
  &#125;
  next();
  //æŠŠä¸»å‹•æ¬Šäº¤çµ¦ä¸‹ä¸€å€‹ middleware
&#125;);

module.exports = mongoose.model(&quot;User&quot;, userSchema);
</code></pre><h3 id="4-ä½¿ç”¨-joi-é€²è¡Œæ•¸æ“šé©—è­‰"><a class="markdownIt-Anchor" href="#4-ä½¿ç”¨-joi-é€²è¡Œæ•¸æ“šé©—è­‰"></a> 4. ä½¿ç”¨ Joi é€²è¡Œæ•¸æ“šé©—è­‰</h3><p>å®‰è£ Joi ä¾†è‡ªå®šç¾©é©—è­‰è¦å‰‡ï¼Œé©—è­‰æŸå€‹å­—æ®µçš„å€¼æ˜¯å¦åœ¨è³‡æ–™åº«ä¸­å­˜åœ¨ï¼š</p><ul><li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/joi">Joi</a></li></ul><pre class="highlight"><code class="bash">npm i joi
</code></pre><p>ç”¨æ–¼é©—è­‰ç”¨æˆ¶ç¶“é Routes çš„æ•¸æ“šæ˜¯å¦ç¬¦åˆè¦æ±‚ ï¼š</p><pre class="highlight"><code class="js">const Joi = require(&quot;joi&quot;);

const registorValidation = (data) =&gt; &#123;
  const schema = Joi.object(&#123;
    username: Joi.string().min(3).max(12).required().messages(&#123;
      &quot;string.min&quot;: &quot;ç”¨æˆ¶åç¨±é•·åº¦è‡³å°‘ 3 å€‹å­—å…ƒã€‚&quot;,
      &quot;string.max&quot;: &quot;ç”¨æˆ¶åç¨±é•·åº¦ä¸èƒ½è¶…é 12 å€‹å­—å…ƒã€‚&quot;,
      &quot;string.empty&quot;: &quot;ç”¨æˆ¶åç¨±ä¸èƒ½ç‚ºç©ºã€‚&quot;,
      &quot;any.required&quot;: &quot;ç”¨æˆ¶åç¨±ç‚ºå¿…å¡«é …ã€‚&quot;,
    &#125;),
    email: Joi.string().min(5).max(25).required().email().messages(&#123;
      &quot;string.min&quot;: &quot;é›»å­ä¿¡ç®±è‡³å°‘ 3 å€‹å­—å…ƒã€‚&quot;,
      &quot;string.max&quot;: &quot;é›»å­ä¿¡ç®±ä¸èƒ½è¶…é 12 å€‹å­—å…ƒã€‚&quot;,
      &quot;string.email&quot;: &quot;è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€ã€‚&quot;,
      &quot;string.empty&quot;: &quot;é›»å­ä¿¡ç®±ä¸èƒ½ç‚ºç©ºã€‚&quot;,
      &quot;any.required&quot;: &quot;é›»å­ä¿¡ç®±ç‚ºå¿…å¡«é …&quot;,
    &#125;),
    password: Joi.string()
      .min(8)
      .max(15)
      .required()
      .pattern(new RegExp(&quot;^(?=.*[a-zA-Z])(?=.*[0-9])[a-zA-Z0-9]&#123;8,15&#125;$&quot;))
      .messages(&#123;
        &quot;string.min&quot;: &quot;å¯†ç¢¼è‡³å°‘ 8å€‹å­—å…ƒã€‚&quot;,
        &quot;string.max&quot;: &quot;å¯†ç¢¼ä¸èƒ½è¶…é 15 å€‹å­—å…ƒã€‚&quot;,
        &quot;string.pattern.base&quot;:
          &quot;å¯†ç¢¼å¿…é¡»è‡³å°‘åŒ…å«ä¸€å€‹å­—æ¯å’Œä¸€å€‹æ•¸å­—ï¼Œä¸”é•·åº¦åœ¨ 8 åˆ° 15 å€‹å­—å…ƒä¹‹é–“ã€‚&quot;,
        &quot;string.empty&quot;: &quot;å¯†ç¢¼ä¸èƒ½ç‚ºç©ºã€‚&quot;,
        &quot;any.required&quot;: &quot;å¯†ç¢¼æ˜¯å¿…å¡«é …ã€‚&quot;,
      &#125;),
    role: Joi.string()
      .valid(&quot;Student&quot;, &quot;Instructor&quot;) // é™åˆ¶ç‚º &quot;Student&quot; æˆ– &quot;Instructor&quot;
      .required()
      .messages(&#123;
        &quot;string.empty&quot;: &quot;èº«ä»½ä¸èƒ½ç‚ºç©ºã€‚&quot;,
        &quot;any.required&quot;: &quot;èº«ä»½æ˜¯å¿…å¡«çš„ã€‚&quot;,
        &quot;any.invalid&quot;: &quot;èº«ä»½å¿…é ˆæ˜¯ Student æˆ– Instructorã€‚&quot;,
        &quot;any.only&quot;: &quot;èº«ä»½å¿…é ˆæ˜¯ Student æˆ– Instructorã€‚&quot;,
      &#125;),
  &#125;);
  return schema.validate(data);
&#125;;

const loginValidation = (data) =&gt; &#123;
  const schema = Joi.object(&#123;
    email: Joi.string().required().email().messages(&#123;
      &quot;string.email&quot;: &quot;ğŸš«æ­¤ä¿¡ç®±å°šæœªè¨»å†Œã€‚&quot;,
      &quot;string.empty&quot;: &quot;ğŸš«é›»å­ä¿¡ç®±ä¸èƒ½ç‚ºç©ºã€‚&quot;,
      &quot;any.required&quot;: &quot;é›»å­ä¿¡ç®±ç‚ºå¿…å¡«é …ã€‚&quot;,
    &#125;),
    password: Joi.string().required().messages(&#123;
      &quot;string.pattern.base&quot;: &quot;ğŸš«é‚®ç®±æˆ–å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚&quot;,
      &quot;string.empty&quot;: &quot;ğŸš«å¯†ç¢¼ä¸èƒ½ç‚ºç©ºã€‚&quot;,
      &quot;any.required&quot;: &quot;å¯†ç¢¼æ˜¯å¿…å¡«é …ã€‚&quot;,
    &#125;),
  &#125;);
  return schema.validate(data);
&#125;;

module.exports.registorValidation = registorValidation;
module.exports.loginValidation = loginValidation;
</code></pre><h3 id="5-å»ºç«‹-jwt-é©—è­‰çš„-middleware"><a class="markdownIt-Anchor" href="#5-å»ºç«‹-jwt-é©—è­‰çš„-middleware"></a> 5. å»ºç«‹ JWT é©—è­‰çš„ middleware</h3><p>é€é JWT ä¾†é©—è­‰èº«ä»½ç­‰ç›¸é—œè³‡è¨Šï¼š</p><ul><li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/jsonwebtoken">jsonwebtoken</a></li></ul><pre class="highlight"><code class="bash">npm install jsonwebtoken
</code></pre><pre class="highlight"><code class="js">const JWT = require(&quot;jsonwebtoken&quot;); //JWT é©—è­‰
//é©—è­‰ token
function authenticateToken(req, res, next) &#123;
  const token = req.header(&quot;Authorization&quot;); // å¾ Authorization æ¨™é ­ä¸­å–å‡º token

  if (!token) &#123;
    return res.status(401).send(&quot;æ²’æœ‰æä¾› token&quot;);
  &#125;

  const jwtToken = token.replace(&quot;JWT &quot;, &quot;&quot;);

  JWT.verify(jwtToken, process.env.PASSPORT_SECRET, (err, user) =&gt; &#123;
    if (err) &#123;
      return res.status(403).send(&quot;ç„¡æ•ˆçš„ token&quot;);
    &#125;
    req.user = user; // ä¿å­˜è§£æå¾Œçš„ç”¨æˆ¶ä¿¡æ¯
    next(); // é€šéé©—è­‰ï¼Œç¹¼çºŒåŸ·è¡Œå¾ŒçºŒçš„è·¯ç”±
  &#125;);
&#125;
</code></pre><h3 id="6-è¨­è¨ˆ-restful-apiä¾‹å¦‚ç”¨æ–¼ç®¡ç†ç”¨æˆ¶çš„-crud-åŠŸèƒ½"><a class="markdownIt-Anchor" href="#6-è¨­è¨ˆ-restful-apiä¾‹å¦‚ç”¨æ–¼ç®¡ç†ç”¨æˆ¶çš„-crud-åŠŸèƒ½"></a> 6. è¨­è¨ˆ RESTful APIï¼Œä¾‹å¦‚ç”¨æ–¼ç®¡ç†ç”¨æˆ¶çš„ CRUD åŠŸèƒ½ï¼š</h3><p>å»ºç«‹ä½¿ç”¨è€…</p><pre class="highlight"><code class="js">const router = require(&quot;express&quot;).Router();
const User = require(&quot;../model&quot;).user;
const bcrypt = require(&quot;bcrypt&quot;); //ç”¨æ–¼åŠ å¯†ç”¨æˆ¶è¨Šæ¯ ex.password

const registerValidation = require(&quot;../validation&quot;).registorValidation;
const loginValidation = require(&quot;../validation&quot;).loginValidation;
const editorValidation = require(&quot;../validation&quot;).editorValidation;

router.post(&quot;/register&quot;, async (req, res) =&gt; &#123;
  let &#123; username, email, password, role &#125; = req.body;
  let &#123; error &#125; = registerValidation(req.body); //ç¢ºèªæ•¸æ“šæ˜¯å¦ç¬¦åˆè¦å®š
  if (error) &#123;
    return res.status(400).send(error.details[0].message);
  &#125;
  const emailExist = await User.findOne(&#123; email &#125;).exec();
  if (emailExist) &#123;
    return res.status(400).send(&quot;è©²ä¿¡ç®±å·²è¢«è¨»å†Œï¼Œè«‹æ›´æ¢åˆ¥çš„ä¿¡ç®±ã€‚&quot;);
  &#125;
  try &#123;
    let newUser = new User(&#123; username, email, password, role &#125;);
    await newUser.save();
    return res.send(&#123;
      msg: &quot;ä½¿ç”¨è€…æˆåŠŸå„²å­˜&quot;,
      user: &#123;
        id: newUser._id,
        username: newUser.username,
        email: newUser.email,
        password: newUser.password,
        role: newUser.role,
      &#125;,
    &#125;);
  &#125; catch (e) &#123;
    return res.status(500).send(&quot;ç„¡æ³•å„²å­˜ä½¿ç”¨è€…&quot;);
  &#125;
&#125;);
</code></pre><p>ç”¨æˆ¶ç™»å…¥</p><pre class="highlight"><code class="js">router.post(&quot;/login&quot;, async (req, res) =&gt; &#123;
let &#123; email, password &#125; = req.body;
let &#123; error &#125; = loginValidation(req.body);
if (error) &#123;
return res.status(400).send(error.details[0].message);
&#125;
const FUser = await User.findOne(&#123; email &#125;).exec();
if (!FUser) &#123;
return res.status(400).send(&quot;æ‰¾ä¸åˆ°æ­¤ç”¨æˆ¶ï¼Œè«‹ç¢ºèªä¿¡ç®±æ˜¯å¦æ­£ç¢ºã€‚&quot;);
&#125;
FUser.comparePassword(password, (err, isMatch) =&gt; &#123;
if (err) return res.status(500).send(err);
if (isMatch) &#123;
const tokenObj = &#123; \_id: FUser.\_id, email: FUser.email &#125;;
const token = JWT.sign(tokenObj, process.env.PASSPORT_SECRET);
return res.send(&#123;
msg: &quot;æˆåŠŸç™»å…¥&quot;,
token: &quot;JWT &quot; + token, //å¿…å®šè¦åœ¨ JWT å¾ŒåŠ ä¸€å€‹ç©ºæ ¼ å¦å‰‡æœƒç„¡æ³•å–å¾—æˆæ¬Š
user: FUser,
&#125;);
&#125; else &#123;
return res.status(401).send(&quot;å¯†ç¢¼éŒ¯èª¤&quot;);
&#125;
&#125;);
&#125;);
</code></pre><p>ç”¨æˆ¶è³‡æ–™ä¿®æ”¹</p><pre class="highlight"><code class="js">router.patch(&quot;/:\_id&quot;, authenticateToken, async (req, res) =&gt; &#123;
let &#123; \_id &#125; = req.params;

// é©—è­‰è«‹æ±‚æ•¸æ“š
let &#123; error &#125; = editorValidation(req.body);
if (error) &#123;
return res.status(400).send(&#123; error: error.details[0].message &#125;); // è¿”å›å…·é«”éŒ¯èª¤ä¿¡æ¯
&#125;

try &#123;
// æŸ¥æ‰¾ç”¨æˆ¶
let Uf = await User.findById(\_id).exec();
if (!Uf) &#123;
return res.status(404).send(&#123; error: &quot;æ‰¾ä¸åˆ°æ­¤ç”¨æˆ¶&quot; &#125;); // ç”¨æˆ¶æœªæ‰¾åˆ°
&#125;

    // é©—è­‰ç•¶å‰ç”¨æˆ¶æ˜¯å¦èˆ‡è¦ä¿®æ”¹çš„ç”¨æˆ¶ç›¸åŒ
    if (Uf._id.toString() === req.user._id.toString()) &#123;
      if (Object.keys(req.body).length === 0) &#123;
        return res.status(400).send(&#123; error: &quot;æ²’æœ‰æä¾›æ›´æ–°è³‡æ–™&quot; &#125;);
      &#125;

      let updatedData = req.body;

      // å¦‚æœæœ‰æä¾›å¯†ç¢¼ï¼Œå‰‡é€²è¡ŒåŠ å¯†è™•ç†
      if (updatedData.password) &#123;
        const salt = await bcrypt.genSalt(10); // ç”Ÿæˆsalt
        updatedData.password = await bcrypt.hash(updatedData.password, salt); // ä½¿ç”¨saltåŠ å¯†å¯†ç¢¼
      &#125;

      // æ›´æ–°ç”¨æˆ¶è³‡æ–™
      const updatedUser = await User.findByIdAndUpdate(_id, updatedData, &#123;
        new: true,
        runValidators: true,
      &#125;);
      console.log(updatedUser);

      if (!updatedUser) &#123;
        return res.status(500).send(&#123; error: &quot;æ›´æ–°å¤±æ•—&quot; &#125;);
      &#125;

      return res.send(&#123; msg: &quot;è³‡æ–™è¢«æ›´æ–°&quot;, user: updatedUser &#125;);
    &#125; else &#123;
      return res.status(403).send(&#123; error: &quot;æ‚¨ç„¡æ¬Šæ›´æ”¹æ­¤è³‡æ–™&quot; &#125;); // æ¬Šé™éŒ¯èª¤
    &#125;

&#125; catch (e) &#123;
return res.status(500).send(&#123; error: e.message &#125;); // ä¼ºæœå™¨éŒ¯èª¤
&#125;
&#125;);

module.exports = router;
</code></pre><div class="pagination"><a href="#" class="page-link" data-page-prefix="MERN" data-page="1">1</a> <a href="#" class="page-link" data-page-prefix="MERN" data-page="2">2</a> <a href="#" class="page-link" data-page-prefix="MERN" data-page="3">3</a></div></div></div><footer id="footer"><div id="footer-wrap"><div>&copy; 2024 - 2025 HenRsã®å°çª© <span id="footer-icon"><i class="fa-solid fa-font-awesome fa-fw"></i> </span>&commat;HenRs</div><div>Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp; <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a></div></div></footer></div><transition name="fade"><div id="preview" ref="preview" v-show="previewShow"><img id="preview-content" ref="previewContent"></div></transition></div><script src="/js/main.js" defer></script><canvas id="fireworks" style="position:fixed;top:0;left:0;width:100vw;height:100vh;pointer-events:none;z-index:32767"></canvas><script src="https://s4.zstatic.net/ajax/libs/animejs/3.2.1/anime.min.js"></script><script src="/js/fireworks.min.js" defer></script><script src="/js/commonpage.min.js" defer></script></body></html>