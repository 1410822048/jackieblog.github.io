<!DOCTYPE html><html lang="zh-TW"><head><meta charset="utf-8"><title>MERN 專案STEP | HenRsの小窩</title><meta name="author" content="HenRs"><meta name="description" content="有關於『我』"><meta name="keywords" content=""><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><link rel="icon" href="/images/avatar.webp"><link rel="preconnect" href="https://s4.zstatic.net"><script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"><link rel="preconnect" href="https://fonts.googleapis.cn"><link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin><link rel="stylesheet" href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"><script>const mixins={}</script><script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script><script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script><script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script><link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"><script src="/js/lib/highlight.js"></script><script src="/js/lib/preview.js"></script><link rel="stylesheet" href="/css/main.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="layout"><transition name="fade"><div id="loading" v-show="loading"><div id="loading-circle"><h2>LOADING</h2><p>加載中···請稍後，如過慢請清理緩存</p><img src="/images/loading.gif"></div></div></transition><div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}"><nav id="desktop-menu"><a class="title" href="/"><span>HENRSの小窩</span> </a><a href="/"><i class="fa-solid fa-house fa-fw"></i> <span>&ensp;首頁</span> </a><a href="/about"><i class="fa-solid fa-id-card fa-fw"></i> <span>&ensp;關於</span> </a><a href="/archives"><i class="fa-solid fa-box-archive fa-fw"></i> <span>&ensp;項目</span> </a><a href="/categories"><i class="fa-solid fa-bookmark fa-fw"></i> <span>&ensp;類別</span> </a><a href="/tags"><i class="fa-solid fa-tags fa-fw"></i> <span>&ensp;標籤</span></a></nav><nav id="mobile-menu"><div class="title" @click="showMenuItems = !showMenuItems"><i class="fa-solid fa-bars fa-fw"></i> <span>&emsp;HENRSの小窩</span></div><transition name="slide"><div class="items" v-show="showMenuItems"><a href="/"><div class="item"><div style="min-width:20px;max-width:50px;width:10%"><i class="fa-solid fa-house fa-fw"></i></div><div style="min-width:100px;max-width:150%;width:20%">首頁</div></div></a><a href="/about"><div class="item"><div style="min-width:20px;max-width:50px;width:10%"><i class="fa-solid fa-id-card fa-fw"></i></div><div style="min-width:100px;max-width:150%;width:20%">關於</div></div></a><a href="/archives"><div class="item"><div style="min-width:20px;max-width:50px;width:10%"><i class="fa-solid fa-box-archive fa-fw"></i></div><div style="min-width:100px;max-width:150%;width:20%">項目</div></div></a><a href="/categories"><div class="item"><div style="min-width:20px;max-width:50px;width:10%"><i class="fa-solid fa-bookmark fa-fw"></i></div><div style="min-width:100px;max-width:150%;width:20%">類別</div></div></a><a href="/tags"><div class="item"><div style="min-width:20px;max-width:50px;width:10%"><i class="fa-solid fa-tags fa-fw"></i></div><div style="min-width:100px;max-width:150%;width:20%">標籤</div></div></a></div></transition></nav></div><transition name="fade"><div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div></transition><div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'"><div class="article"><div><h1>MERN 專案STEP</h1></div><div class="info"><span class="date"><span class="icon"><i class="fa-solid fa-calendar fa-fw"></i> </span>2024/8/24 </span><span class="category"><a href="/categories/%E6%95%99%E7%A8%8B/"><span class="icon"><i class="fa-solid fa-bookmark fa-fw"></i> </span>教程 </a></span><span class="tags"><span class="icon"><i class="fa-solid fa-tags fa-fw"></i> </span><span class="tag"><a href="/tags/MERN/" style="color:#03a9f4">MERN </a></span><span class="tag"><a href="/tags/MongoDB/" style="color:#ff7d73">MongoDB </a></span><span class="tag"><a href="/tags/Express/" style="color:#ffa2c4">Express </a></span><span class="tag"><a href="/tags/React/" style="color:#00a596">React </a></span><span class="tag"><a href="/tags/Node-js/" style="color:#ffa2c4">Node.js </a></span><span class="tag"><a href="/tags/%E5%85%A8%E7%AB%AF%E9%96%8B%E7%99%BC/" style="color:#00a596">全端開發</a></span></span></div><div class="content" v-pre><h2 id="什麼是-mern-stack"><a class="markdownIt-Anchor" href="#什麼是-mern-stack"></a> 什麼是 MERN Stack？</h2><p>MERN 代表 <strong>MongoDB, Express, React, Node.js</strong>，是一套強大的全端開發技術棧，讓開發者能夠以 <strong>JavaScript</strong> 打造從後端到前端的完整應用程式。</p><ul><li><strong>MongoDB</strong>: NoSQL 資料庫，適合儲存 JSON 格式的文件型資料。</li><li><strong>Express</strong>: Node.js 上的輕量框架，提供後端 API 和中介軟體功能。</li><li><strong>React</strong>: 用於建構前端用戶界面 (UI) 的 JavaScript 函式庫。</li><li><strong>Node.js</strong>: 提供後端運行環境，可執行 JavaScript 程式碼。</li></ul><span id="more"></span><hr><h2 id="mern-專案架構概覽"><a class="markdownIt-Anchor" href="#mern-專案架構概覽"></a> MERN 專案架構概覽</h2><p>一個典型的 MERN 專案會包含以下結構：</p><pre class="highlight"><code class="text">my-mern-project/
├── backend/ # 後端程式碼
│ ├── models/ # MongoDB 資料模型
│ ├── routes/ # Express 路由和 API
│ └── server.js # Node.js 伺服器入口
├── frontend/ # 前端程式碼
│ ├── src/
│ │ ├── components/ # React 組件
│ │ ├── pages/ # 應用程式頁面
│ │ └── App.js # React 應用入口
├── .env # 環境變數配置
├── package.json # 依賴與腳本設定
└── README.md # 專案說明文件
</code></pre><h2 id="專案步驟與核心功能"><a class="markdownIt-Anchor" href="#專案步驟與核心功能"></a> 專案步驟與核心功能</h2><h3 id="1-初始化專案"><a class="markdownIt-Anchor" href="#1-初始化專案"></a> 1. 初始化專案</h3><p>打開 VS Code 先在終端運行以下指令，如未特別設置全都默認即可</p><pre class="highlight"><code class="bash">npm init
npm install express dotenv bcrypt mongoose
</code></pre><h3 id="2-設置-mongodb-資料庫"><a class="markdownIt-Anchor" href="#2-設置-mongodb-資料庫"></a> 2. 設置 MongoDB 資料庫</h3><p>在根目錄創建 server.js 並設置 MongoDB 資料庫。你可以在 MongoDB Atlas 或本地端設置資料庫，並連結到專案：</p><pre class="highlight"><code class="js">const mongoose = require(&quot;mongoose&quot;);
//  mongodb://127.0.0.1:27017/ 前面為固定格式 後綴看你想連結的資料庫
mongoose
  .connect(&quot;mongodb://127.0.0.1:27017/MernDB&quot;)
  .then(() =&gt; console.log(&quot;MongoDB 連線成功&quot;))
  .catch((err) =&gt; console.error(&quot;MongoDB 連線失敗:&quot;, err));
</code></pre><h3 id="3-建立資料模型"><a class="markdownIt-Anchor" href="#3-建立資料模型"></a> 3. 建立資料模型</h3><p>新建一個資料夾並在其中建立 User 及其他資料的相關模型。以下是基礎的 Schema 條件建置：</p><pre class="highlight"><code class="js">const mongoose = require(&quot;mongoose&quot;);
const &#123; Schema &#125; = mongoose;

const userSchema = new Schema(&#123;
  username: &#123;
    type: String,
    required: true,
    minlength: [3, &quot;請至少輸入三個字元&quot;],
    maxlength: [12, &quot;超出字數限制!!&quot;],
  &#125;,
  email: &#123;
    type: String,
    required: true,
    minlength: [5, &quot;請至少輸入五個字元&quot;],
    maxlength: [25, &quot;超出字元限制!!&quot;],
  &#125;,
  password: &#123;
    type: String,
    minlength: [8, &quot;Password must be at least 8 characters&quot;],
    maxlengeh: [15, &quot;Password must be less than 15 characters&quot;],
    validate: &#123;
      validator: function (v) &#123;
        // 檢查是否包含至少一個字母和一個數字，但後續會透過'JOI'這個插件實現 這邊只是用於記憶
        return /^(?=.*[A-Za-z])(?=.*\d)/.test(v);
      &#125;,
      message: &quot;Password must contain at least one letter and one number&quot;,
    &#125;,
  &#125;,
  role: &#123;
    type: String,
    required: true,
    enum: [&quot;Student&quot;, &quot;Instructor&quot;],
  &#125;,
  date: &#123;
    type: Date,
    default: Date.now,
  &#125;,
&#125;);
</code></pre><p>建立 mdoel 的規則並透過 bcrypt 加密，並在 save 動作前觸發：</p><ul><li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/bcrypt">bcrypt</a></li></ul><pre class="highlight"><code class="js">const bcrypt = require(&quot;bcrypt&quot;);
const saltRounds = 14; //加密複雜度 建議在10-14間 step = 2

userSchema.methods.isStudent = function () &#123;
  return this.role == &quot;Student&quot;; //無法用 arrow fc 會抓不到 this
&#125;;

userSchema.methods.isInstructor = function () &#123;
  return this.role == &quot;Instructor&quot;;
&#125;;

userSchema.methods.comparePassword = async function (password, cb) &#123;
  let result;
  try &#123;
    result = await bcrypt.compare(password, this.password);
    return cb(null, result);
  &#125; catch (e) &#123;
    return cb(e, result);
  &#125;
&#125;;

userSchema.pre(&quot;save&quot;, async function (next) &#123;
  //表示在 save 前觸發此 fc
  if (this.isNew || this.isModified(&quot;password&quot;)) &#123;
    //isNew 確認是否為新文檔 || isModified 確認是否經修改過 兩者為 mongoose 內建函數
    const hashedPass = await bcrypt.hash(this.password, saltRounds);
    this.password = hashedPass;
  &#125;
  next();
  //把主動權交給下一個 middleware
&#125;);

module.exports = mongoose.model(&quot;User&quot;, userSchema);
</code></pre><h3 id="4-使用-joi-進行數據驗證"><a class="markdownIt-Anchor" href="#4-使用-joi-進行數據驗證"></a> 4. 使用 Joi 進行數據驗證</h3><p>安裝 Joi 來自定義驗證規則，驗證某個字段的值是否在資料庫中存在：</p><ul><li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/joi">Joi</a></li></ul><pre class="highlight"><code class="bash">npm i joi
</code></pre><p>用於驗證用戶經過 Routes 的數據是否符合要求 ：</p><pre class="highlight"><code class="js">const Joi = require(&quot;joi&quot;);

const registorValidation = (data) =&gt; &#123;
  const schema = Joi.object(&#123;
    username: Joi.string().min(3).max(12).required().messages(&#123;
      &quot;string.min&quot;: &quot;用戶名稱長度至少 3 個字元。&quot;,
      &quot;string.max&quot;: &quot;用戶名稱長度不能超過 12 個字元。&quot;,
      &quot;string.empty&quot;: &quot;用戶名稱不能為空。&quot;,
      &quot;any.required&quot;: &quot;用戶名稱為必填項。&quot;,
    &#125;),
    email: Joi.string().min(5).max(25).required().email().messages(&#123;
      &quot;string.min&quot;: &quot;電子信箱至少 3 個字元。&quot;,
      &quot;string.max&quot;: &quot;電子信箱不能超過 12 個字元。&quot;,
      &quot;string.email&quot;: &quot;請輸入有效的電子郵件地址。&quot;,
      &quot;string.empty&quot;: &quot;電子信箱不能為空。&quot;,
      &quot;any.required&quot;: &quot;電子信箱為必填項&quot;,
    &#125;),
    password: Joi.string()
      .min(8)
      .max(15)
      .required()
      .pattern(new RegExp(&quot;^(?=.*[a-zA-Z])(?=.*[0-9])[a-zA-Z0-9]&#123;8,15&#125;$&quot;))
      .messages(&#123;
        &quot;string.min&quot;: &quot;密碼至少 8個字元。&quot;,
        &quot;string.max&quot;: &quot;密碼不能超過 15 個字元。&quot;,
        &quot;string.pattern.base&quot;:
          &quot;密碼必须至少包含一個字母和一個數字，且長度在 8 到 15 個字元之間。&quot;,
        &quot;string.empty&quot;: &quot;密碼不能為空。&quot;,
        &quot;any.required&quot;: &quot;密碼是必填項。&quot;,
      &#125;),
    role: Joi.string()
      .valid(&quot;Student&quot;, &quot;Instructor&quot;) // 限制為 &quot;Student&quot; 或 &quot;Instructor&quot;
      .required()
      .messages(&#123;
        &quot;string.empty&quot;: &quot;身份不能為空。&quot;,
        &quot;any.required&quot;: &quot;身份是必填的。&quot;,
        &quot;any.invalid&quot;: &quot;身份必須是 Student 或 Instructor。&quot;,
        &quot;any.only&quot;: &quot;身份必須是 Student 或 Instructor。&quot;,
      &#125;),
  &#125;);
  return schema.validate(data);
&#125;;

const loginValidation = (data) =&gt; &#123;
  const schema = Joi.object(&#123;
    email: Joi.string().required().email().messages(&#123;
      &quot;string.email&quot;: &quot;🚫此信箱尚未註册。&quot;,
      &quot;string.empty&quot;: &quot;🚫電子信箱不能為空。&quot;,
      &quot;any.required&quot;: &quot;電子信箱為必填項。&quot;,
    &#125;),
    password: Joi.string().required().messages(&#123;
      &quot;string.pattern.base&quot;: &quot;🚫邮箱或密码错误，请重新输入。&quot;,
      &quot;string.empty&quot;: &quot;🚫密碼不能為空。&quot;,
      &quot;any.required&quot;: &quot;密碼是必填項。&quot;,
    &#125;),
  &#125;);
  return schema.validate(data);
&#125;;

module.exports.registorValidation = registorValidation;
module.exports.loginValidation = loginValidation;
</code></pre><h3 id="5-建立-jwt-驗證的-middleware"><a class="markdownIt-Anchor" href="#5-建立-jwt-驗證的-middleware"></a> 5. 建立 JWT 驗證的 middleware</h3><p>透過 JWT 來驗證身份等相關資訊：</p><ul><li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/jsonwebtoken">jsonwebtoken</a></li></ul><pre class="highlight"><code class="bash">npm install jsonwebtoken
</code></pre><pre class="highlight"><code class="js">const JWT = require(&quot;jsonwebtoken&quot;); //JWT 驗證
//驗證 token
function authenticateToken(req, res, next) &#123;
  const token = req.header(&quot;Authorization&quot;); // 從 Authorization 標頭中取出 token

  if (!token) &#123;
    return res.status(401).send(&quot;沒有提供 token&quot;);
  &#125;

  const jwtToken = token.replace(&quot;JWT &quot;, &quot;&quot;);

  JWT.verify(jwtToken, process.env.PASSPORT_SECRET, (err, user) =&gt; &#123;
    if (err) &#123;
      return res.status(403).send(&quot;無效的 token&quot;);
    &#125;
    req.user = user; // 保存解析後的用戶信息
    next(); // 通過驗證，繼續執行後續的路由
  &#125;);
&#125;
</code></pre><h3 id="6-設計-restful-api例如用於管理用戶的-crud-功能"><a class="markdownIt-Anchor" href="#6-設計-restful-api例如用於管理用戶的-crud-功能"></a> 6. 設計 RESTful API，例如用於管理用戶的 CRUD 功能：</h3><p>建立使用者</p><pre class="highlight"><code class="js">const router = require(&quot;express&quot;).Router();
const User = require(&quot;../model&quot;).user;
const bcrypt = require(&quot;bcrypt&quot;); //用於加密用戶訊息 ex.password

const registerValidation = require(&quot;../validation&quot;).registorValidation;
const loginValidation = require(&quot;../validation&quot;).loginValidation;
const editorValidation = require(&quot;../validation&quot;).editorValidation;

router.post(&quot;/register&quot;, async (req, res) =&gt; &#123;
  let &#123; username, email, password, role &#125; = req.body;
  let &#123; error &#125; = registerValidation(req.body); //確認數據是否符合規定
  if (error) &#123;
    return res.status(400).send(error.details[0].message);
  &#125;
  const emailExist = await User.findOne(&#123; email &#125;).exec();
  if (emailExist) &#123;
    return res.status(400).send(&quot;該信箱已被註册，請更换別的信箱。&quot;);
  &#125;
  try &#123;
    let newUser = new User(&#123; username, email, password, role &#125;);
    await newUser.save();
    return res.send(&#123;
      msg: &quot;使用者成功儲存&quot;,
      user: &#123;
        id: newUser._id,
        username: newUser.username,
        email: newUser.email,
        password: newUser.password,
        role: newUser.role,
      &#125;,
    &#125;);
  &#125; catch (e) &#123;
    return res.status(500).send(&quot;無法儲存使用者&quot;);
  &#125;
&#125;);
</code></pre><p>用戶登入</p><pre class="highlight"><code class="js">router.post(&quot;/login&quot;, async (req, res) =&gt; &#123;
let &#123; email, password &#125; = req.body;
let &#123; error &#125; = loginValidation(req.body);
if (error) &#123;
return res.status(400).send(error.details[0].message);
&#125;
const FUser = await User.findOne(&#123; email &#125;).exec();
if (!FUser) &#123;
return res.status(400).send(&quot;找不到此用戶，請確認信箱是否正確。&quot;);
&#125;
FUser.comparePassword(password, (err, isMatch) =&gt; &#123;
if (err) return res.status(500).send(err);
if (isMatch) &#123;
const tokenObj = &#123; \_id: FUser.\_id, email: FUser.email &#125;;
const token = JWT.sign(tokenObj, process.env.PASSPORT_SECRET);
return res.send(&#123;
msg: &quot;成功登入&quot;,
token: &quot;JWT &quot; + token, //必定要在 JWT 後加一個空格 否則會無法取得授權
user: FUser,
&#125;);
&#125; else &#123;
return res.status(401).send(&quot;密碼錯誤&quot;);
&#125;
&#125;);
&#125;);
</code></pre><p>用戶資料修改</p><pre class="highlight"><code class="js">router.patch(&quot;/:\_id&quot;, authenticateToken, async (req, res) =&gt; &#123;
let &#123; \_id &#125; = req.params;

// 驗證請求數據
let &#123; error &#125; = editorValidation(req.body);
if (error) &#123;
return res.status(400).send(&#123; error: error.details[0].message &#125;); // 返回具體錯誤信息
&#125;

try &#123;
// 查找用戶
let Uf = await User.findById(\_id).exec();
if (!Uf) &#123;
return res.status(404).send(&#123; error: &quot;找不到此用戶&quot; &#125;); // 用戶未找到
&#125;

    // 驗證當前用戶是否與要修改的用戶相同
    if (Uf._id.toString() === req.user._id.toString()) &#123;
      if (Object.keys(req.body).length === 0) &#123;
        return res.status(400).send(&#123; error: &quot;沒有提供更新資料&quot; &#125;);
      &#125;

      let updatedData = req.body;

      // 如果有提供密碼，則進行加密處理
      if (updatedData.password) &#123;
        const salt = await bcrypt.genSalt(10); // 生成salt
        updatedData.password = await bcrypt.hash(updatedData.password, salt); // 使用salt加密密碼
      &#125;

      // 更新用戶資料
      const updatedUser = await User.findByIdAndUpdate(_id, updatedData, &#123;
        new: true,
        runValidators: true,
      &#125;);
      console.log(updatedUser);

      if (!updatedUser) &#123;
        return res.status(500).send(&#123; error: &quot;更新失敗&quot; &#125;);
      &#125;

      return res.send(&#123; msg: &quot;資料被更新&quot;, user: updatedUser &#125;);
    &#125; else &#123;
      return res.status(403).send(&#123; error: &quot;您無權更改此資料&quot; &#125;); // 權限錯誤
    &#125;

&#125; catch (e) &#123;
return res.status(500).send(&#123; error: e.message &#125;); // 伺服器錯誤
&#125;
&#125;);

module.exports = router;
</code></pre><div class="pagination"><a href="#" class="page-link" data-page-prefix="MERN" data-page="1">1</a> <a href="#" class="page-link" data-page-prefix="MERN" data-page="2">2</a> <a href="#" class="page-link" data-page-prefix="MERN" data-page="3">3</a></div></div></div><footer id="footer"><div id="footer-wrap"><div>&copy; 2024 - 2025 HenRsの小窩 <span id="footer-icon"><i class="fa-solid fa-font-awesome fa-fw"></i> </span>&commat;HenRs</div><div>Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp; <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a></div></div></footer></div><transition name="fade"><div id="preview" ref="preview" v-show="previewShow"><img id="preview-content" ref="previewContent"></div></transition></div><script src="/js/main.js" defer></script><canvas id="fireworks" style="position:fixed;top:0;left:0;width:100vw;height:100vh;pointer-events:none;z-index:32767"></canvas><script src="https://s4.zstatic.net/ajax/libs/animejs/3.2.1/anime.min.js"></script><script src="/js/fireworks.min.js" defer></script><script src="/js/commonpage.min.js" defer></script></body></html>