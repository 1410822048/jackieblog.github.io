
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <title>MERN 專案STEP | HenRsの小窩</title>
    <meta name="author" content="HenRs" />
    <meta name="description" content="有關於『我』" />
    <meta name="keywords" content="" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/avatar.webp" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<!-- <link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" /> -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>



<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />
<meta name="generator" content="Hexo 7.3.0"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加載中···請稍後，如過慢請清理緩存</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>HENRSの小窩</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;首頁</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;關於</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;項目</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;類別</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;標籤</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;HENRSの小窩</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">首頁</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">關於</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">項目</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">類別</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">標籤</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>MERN 專案STEP</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/8/24
        </span>
        
        <span class="category">
            <a href="/categories/%E4%BD%9C%E5%93%81/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                作品
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            
            <span class="tag">
                
                <a href="/tags/MERN/" style="color: #ffa2c4">
                    MERN
                </a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/MongoDB/" style="color: #00a596">
                    MongoDB
                </a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/Express/" style="color: #00bcd4">
                    Express
                </a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/React/" style="color: #ff7d73">
                    React
                </a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/Node-js/" style="color: #ffa2c4">
                    Node.js
                </a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/%E5%85%A8%E7%AB%AF%E9%96%8B%E7%99%BC/" style="color: #03a9f4">
                    全端開發
                </a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>
        <h2 id="什麼是-mern-stack"><a class="markdownIt-Anchor" href="#什麼是-mern-stack"></a> 什麼是 MERN Stack？</h2>
<p>MERN 代表 <strong>MongoDB, Express, React, Node.js</strong>，是一套強大的全端開發技術棧，讓開發者能夠以 <strong>JavaScript</strong> 打造從後端到前端的完整應用程式。</p>
<ul>
<li><strong>MongoDB</strong>: NoSQL 資料庫，適合儲存 JSON 格式的文件型資料。</li>
<li><strong>Express</strong>: Node.js 上的輕量框架，提供後端 API 和中介軟體功能。</li>
<li><strong>React</strong>: 用於建構前端用戶界面 (UI) 的 JavaScript 函式庫。</li>
<li><strong>Node.js</strong>: 提供後端運行環境，可執行 JavaScript 程式碼。</li>
</ul>
<span id="more"></span>
<hr />
<h2 id="mern-專案架構概覽"><a class="markdownIt-Anchor" href="#mern-專案架構概覽"></a> MERN 專案架構概覽</h2>
<p>一個典型的 MERN 專案會包含以下結構：</p>
<pre class="highlight"><code class="text">my-mern-project/
├── backend/                 # 後端程式碼
│   ├── models/              # MongoDB 資料模型
│   ├── routes/              # Express 路由和 API
│   └── server.js            # Node.js 伺服器入口
├── frontend/                # 前端程式碼
│   ├── src/
│   │   ├── components/      # React 組件
│   │   ├── pages/           # 應用程式頁面
│   │   └── App.js           # React 應用入口
├── .env                     # 環境變數配置
├── package.json             # 依賴與腳本設定
└── README.md                # 專案說明文件

</code></pre>
<h2 id="專案步驟與核心功能"><a class="markdownIt-Anchor" href="#專案步驟與核心功能"></a> 專案步驟與核心功能</h2>
<h3 id="1-打開-vs-code-先在終端運行以下指令如未特別設置全都默認即可"><a class="markdownIt-Anchor" href="#1-打開-vs-code-先在終端運行以下指令如未特別設置全都默認即可"></a> 1. 打開 VS Code 先在終端運行以下指令，如未特別設置全都默認即可</h3>
<pre class="highlight"><code class="bash">npm init
npm install express dotenv bcrypt mongoose
</code></pre>
<h3 id="2-設置-mongodb-資料庫"><a class="markdownIt-Anchor" href="#2-設置-mongodb-資料庫"></a> 2. 設置 MongoDB 資料庫</h3>
<p>在 MongoDB Atlas 或本地端設置資料庫，並連結到專案：</p>
<pre class="highlight"><code class="js"><span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;mongoose&quot;</span>);
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MONGO_URI</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">MONGO_URI</span>;
<span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;dotenv&quot;</span>).<span class="hljs-title function_">config</span>();

mongoose
  .<span class="hljs-title function_">connect</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">MONGO_URI</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;MongoDB 連線成功&quot;</span>))
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;MongoDB 連線失敗:&quot;</span>, err));
</code></pre>
<h3 id="3-建立-user-及-其他資料的相關-model"><a class="markdownIt-Anchor" href="#3-建立-user-及-其他資料的相關-model"></a> 3. 建立 User 及 其他資料的相關 Model</h3>
<p>基礎的 Schema 條件建置：</p>
<pre class="highlight"><code class="js"><span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;mongoose&quot;</span>);
<span class="hljs-keyword">const</span> &#123; <span class="hljs-title class_">Schema</span> &#125; = mongoose;

<span class="hljs-keyword">const</span> userSchema = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Schema</span>(&#123;
  <span class="hljs-attr">username</span>: &#123;
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
    <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">minlength</span>: [<span class="hljs-number">3</span>, <span class="hljs-string">&quot;請至少輸入三個字元&quot;</span>],
    <span class="hljs-attr">maxlength</span>: [<span class="hljs-number">12</span>, <span class="hljs-string">&quot;超出字數限制!!&quot;</span>],
  &#125;,
  <span class="hljs-attr">email</span>: &#123;
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
    <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">minlength</span>: [<span class="hljs-number">5</span>, <span class="hljs-string">&quot;請至少輸入五個字元&quot;</span>],
    <span class="hljs-attr">maxlength</span>: [<span class="hljs-number">25</span>, <span class="hljs-string">&quot;超出字元限制!!&quot;</span>],
  &#125;,
  <span class="hljs-attr">password</span>: &#123;
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
    <span class="hljs-attr">minlength</span>: [<span class="hljs-number">8</span>, <span class="hljs-string">&quot;Password must be at least 8 characters&quot;</span>],
    <span class="hljs-attr">maxlengeh</span>: [<span class="hljs-number">15</span>, <span class="hljs-string">&quot;Password must be less than 15 characters&quot;</span>],
    <span class="hljs-attr">validate</span>: &#123;
      <span class="hljs-attr">validator</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">v</span>) &#123;
        <span class="hljs-comment">// 檢查是否包含至少一個字母和一個數字，但後續會透過&#x27;JOI&#x27;這個插件實現 這邊只是用於記憶</span>
        <span class="hljs-keyword">return</span> <span class="hljs-regexp">/^(?=.*[A-Za-z])(?=.*\d)/</span>.<span class="hljs-title function_">test</span>(v);
      &#125;,
      <span class="hljs-attr">message</span>: <span class="hljs-string">&quot;Password must contain at least one letter and one number&quot;</span>,
    &#125;,
  &#125;,
  <span class="hljs-attr">role</span>: &#123;
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
    <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">enum</span>: [<span class="hljs-string">&quot;Student&quot;</span>, <span class="hljs-string">&quot;Instructor&quot;</span>],
  &#125;,
  <span class="hljs-attr">date</span>: &#123;
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Date</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-property">now</span>,
  &#125;,
&#125;);
</code></pre>
<p>建立 mdoel 的規則並透過 bcrypt 加密，並在 save 動作前觸發：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/bcrypt">bcrypt</a></li>
</ul>
<pre class="highlight"><code class="js"><span class="hljs-keyword">const</span> bcrypt = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;bcrypt&quot;</span>);
<span class="hljs-keyword">const</span> saltRounds = <span class="hljs-number">14</span>; <span class="hljs-comment">//加密複雜度 建議在10-14間 step = 2</span>

userSchema.<span class="hljs-property">methods</span>.<span class="hljs-property">isStudent</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">role</span> == <span class="hljs-string">&quot;Student&quot;</span>; <span class="hljs-comment">//無法用 arrow fc 會抓不到 this</span>
&#125;;

userSchema.<span class="hljs-property">methods</span>.<span class="hljs-property">isInstructor</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">role</span> == <span class="hljs-string">&quot;Instructor&quot;</span>;
&#125;;

userSchema.<span class="hljs-property">methods</span>.<span class="hljs-property">comparePassword</span> = <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">password, cb</span>) &#123;
  <span class="hljs-keyword">let</span> result;
  <span class="hljs-keyword">try</span> &#123;
    result = <span class="hljs-keyword">await</span> bcrypt.<span class="hljs-title function_">compare</span>(password, <span class="hljs-variable language_">this</span>.<span class="hljs-property">password</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">cb</span>(<span class="hljs-literal">null</span>, result);
  &#125; <span class="hljs-keyword">catch</span> (e) &#123;
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">cb</span>(e, result);
  &#125;
&#125;;

userSchema.<span class="hljs-title function_">pre</span>(<span class="hljs-string">&quot;save&quot;</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">next</span>) &#123;
  <span class="hljs-comment">//表示在 save 前觸發此 fc</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isNew</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isModified</span>(<span class="hljs-string">&quot;password&quot;</span>)) &#123;
    <span class="hljs-comment">//isNew 確認是否為新文檔 || isModified 確認是否經修改過 兩者為 mongoose 內建函數</span>
    <span class="hljs-keyword">const</span> hashedPass = <span class="hljs-keyword">await</span> bcrypt.<span class="hljs-title function_">hash</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">password</span>, saltRounds);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">password</span> = hashedPass;
  &#125;
  <span class="hljs-title function_">next</span>();
  <span class="hljs-comment">//把主動權交給下一個 middleware</span>
&#125;);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = mongoose.<span class="hljs-title function_">model</span>(<span class="hljs-string">&quot;User&quot;</span>, userSchema);
</code></pre>
<h3 id="4-透過-joi-建立各項驗證"><a class="markdownIt-Anchor" href="#4-透過-joi-建立各項驗證"></a> 4. 透過 JOI 建立各項驗證</h3>
<p>用於驗證用戶經過 Routes 的數據是否符合要求 ：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/joi">Joi</a></li>
</ul>
<pre class="highlight"><code class="js"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Joi</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;joi&quot;</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">registorValidation</span> = (<span class="hljs-params">data</span>) =&gt; &#123;
  <span class="hljs-keyword">const</span> schema = <span class="hljs-title class_">Joi</span>.<span class="hljs-title function_">object</span>(&#123;
    <span class="hljs-attr">username</span>: <span class="hljs-title class_">Joi</span>.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">min</span>(<span class="hljs-number">3</span>).<span class="hljs-title function_">max</span>(<span class="hljs-number">12</span>).<span class="hljs-title function_">required</span>().<span class="hljs-title function_">messages</span>(&#123;
      <span class="hljs-string">&quot;string.min&quot;</span>: <span class="hljs-string">&quot;用戶名稱長度至少 3 個字元。&quot;</span>,
      <span class="hljs-string">&quot;string.max&quot;</span>: <span class="hljs-string">&quot;用戶名稱長度不能超過 12 個字元。&quot;</span>,
      <span class="hljs-string">&quot;string.empty&quot;</span>: <span class="hljs-string">&quot;用戶名稱不能為空。&quot;</span>,
      <span class="hljs-string">&quot;any.required&quot;</span>: <span class="hljs-string">&quot;用戶名稱為必填項。&quot;</span>,
    &#125;),
    <span class="hljs-attr">email</span>: <span class="hljs-title class_">Joi</span>.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">min</span>(<span class="hljs-number">5</span>).<span class="hljs-title function_">max</span>(<span class="hljs-number">25</span>).<span class="hljs-title function_">required</span>().<span class="hljs-title function_">email</span>().<span class="hljs-title function_">messages</span>(&#123;
      <span class="hljs-string">&quot;string.min&quot;</span>: <span class="hljs-string">&quot;電子信箱至少 3 個字元。&quot;</span>,
      <span class="hljs-string">&quot;string.max&quot;</span>: <span class="hljs-string">&quot;電子信箱不能超過 12 個字元。&quot;</span>,
      <span class="hljs-string">&quot;string.email&quot;</span>: <span class="hljs-string">&quot;請輸入有效的電子郵件地址。&quot;</span>,
      <span class="hljs-string">&quot;string.empty&quot;</span>: <span class="hljs-string">&quot;電子信箱不能為空。&quot;</span>,
      <span class="hljs-string">&quot;any.required&quot;</span>: <span class="hljs-string">&quot;電子信箱為必填項&quot;</span>,
    &#125;),
    <span class="hljs-attr">password</span>: <span class="hljs-title class_">Joi</span>.<span class="hljs-title function_">string</span>()
      .<span class="hljs-title function_">min</span>(<span class="hljs-number">8</span>)
      .<span class="hljs-title function_">max</span>(<span class="hljs-number">15</span>)
      .<span class="hljs-title function_">required</span>()
      .<span class="hljs-title function_">pattern</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-string">&quot;^(?=.*[a-zA-Z])(?=.*[0-9])[a-zA-Z0-9]&#123;8,15&#125;$&quot;</span>))
      .<span class="hljs-title function_">messages</span>(&#123;
        <span class="hljs-string">&quot;string.min&quot;</span>: <span class="hljs-string">&quot;密碼至少 8個字元。&quot;</span>,
        <span class="hljs-string">&quot;string.max&quot;</span>: <span class="hljs-string">&quot;密碼不能超過 15 個字元。&quot;</span>,
        <span class="hljs-string">&quot;string.pattern.base&quot;</span>:
          <span class="hljs-string">&quot;密碼必须至少包含一個字母和一個數字，且長度在 8 到 15 個字元之間。&quot;</span>,
        <span class="hljs-string">&quot;string.empty&quot;</span>: <span class="hljs-string">&quot;密碼不能為空。&quot;</span>,
        <span class="hljs-string">&quot;any.required&quot;</span>: <span class="hljs-string">&quot;密碼是必填項。&quot;</span>,
      &#125;),
    <span class="hljs-attr">role</span>: <span class="hljs-title class_">Joi</span>.<span class="hljs-title function_">string</span>()
      .<span class="hljs-title function_">valid</span>(<span class="hljs-string">&quot;Student&quot;</span>, <span class="hljs-string">&quot;Instructor&quot;</span>) <span class="hljs-comment">// 限制為 &quot;Student&quot; 或 &quot;Instructor&quot;</span>
      .<span class="hljs-title function_">required</span>()
      .<span class="hljs-title function_">messages</span>(&#123;
        <span class="hljs-string">&quot;string.empty&quot;</span>: <span class="hljs-string">&quot;身份不能為空。&quot;</span>,
        <span class="hljs-string">&quot;any.required&quot;</span>: <span class="hljs-string">&quot;身份是必填的。&quot;</span>,
        <span class="hljs-string">&quot;any.invalid&quot;</span>: <span class="hljs-string">&quot;身份必須是 Student 或 Instructor。&quot;</span>,
        <span class="hljs-string">&quot;any.only&quot;</span>: <span class="hljs-string">&quot;身份必須是 Student 或 Instructor。&quot;</span>,
      &#125;),
  &#125;);
  <span class="hljs-keyword">return</span> schema.<span class="hljs-title function_">validate</span>(data);
&#125;;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">loginValidation</span> = (<span class="hljs-params">data</span>) =&gt; &#123;
  <span class="hljs-keyword">const</span> schema = <span class="hljs-title class_">Joi</span>.<span class="hljs-title function_">object</span>(&#123;
    <span class="hljs-attr">email</span>: <span class="hljs-title class_">Joi</span>.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">required</span>().<span class="hljs-title function_">email</span>().<span class="hljs-title function_">messages</span>(&#123;
      <span class="hljs-string">&quot;string.email&quot;</span>: <span class="hljs-string">&quot;🚫此信箱尚未註册。&quot;</span>,
      <span class="hljs-string">&quot;string.empty&quot;</span>: <span class="hljs-string">&quot;🚫電子信箱不能為空。&quot;</span>,
      <span class="hljs-string">&quot;any.required&quot;</span>: <span class="hljs-string">&quot;電子信箱為必填項。&quot;</span>,
    &#125;),
    <span class="hljs-attr">password</span>: <span class="hljs-title class_">Joi</span>.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">required</span>().<span class="hljs-title function_">messages</span>(&#123;
      <span class="hljs-string">&quot;string.pattern.base&quot;</span>: <span class="hljs-string">&quot;🚫邮箱或密码错误，请重新输入。&quot;</span>,
      <span class="hljs-string">&quot;string.empty&quot;</span>: <span class="hljs-string">&quot;🚫密碼不能為空。&quot;</span>,
      <span class="hljs-string">&quot;any.required&quot;</span>: <span class="hljs-string">&quot;密碼是必填項。&quot;</span>,
    &#125;),
  &#125;);
  <span class="hljs-keyword">return</span> schema.<span class="hljs-title function_">validate</span>(data);
&#125;;

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>.<span class="hljs-property">registorValidation</span> = registorValidation;
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>.<span class="hljs-property">loginValidation</span> = loginValidation;
</code></pre>
<h3 id="5-建立-jwt-驗證的-middleware"><a class="markdownIt-Anchor" href="#5-建立-jwt-驗證的-middleware"></a> 5. 建立 JWT 驗證的 middleware</h3>
<p>透過 JWT 來驗證身份等相關資訊：</p>
<pre class="highlight"><code class="bash">npm install jsonwebtoken
</code></pre>
<pre class="highlight"><code class="js"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">JWT</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;jsonwebtoken&quot;</span>); <span class="hljs-comment">//JWT 驗證</span>
<span class="hljs-comment">//驗證 token</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">authenticateToken</span>(<span class="hljs-params">req, res, next</span>) &#123;
  <span class="hljs-keyword">const</span> token = req.<span class="hljs-title function_">header</span>(<span class="hljs-string">&quot;Authorization&quot;</span>); <span class="hljs-comment">// 從 Authorization 標頭中取出 token</span>

  <span class="hljs-keyword">if</span> (!token) &#123;
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">401</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;沒有提供 token&quot;</span>);
  &#125;

  <span class="hljs-keyword">const</span> jwtToken = token.<span class="hljs-title function_">replace</span>(<span class="hljs-string">&quot;JWT &quot;</span>, <span class="hljs-string">&quot;&quot;</span>);

  <span class="hljs-variable constant_">JWT</span>.<span class="hljs-title function_">verify</span>(jwtToken, process.<span class="hljs-property">env</span>.<span class="hljs-property">PASSPORT_SECRET</span>, <span class="hljs-function">(<span class="hljs-params">err, user</span>) =&gt;</span> &#123;
    <span class="hljs-keyword">if</span> (err) &#123;
      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">403</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;無效的 token&quot;</span>);
    &#125;
    req.<span class="hljs-property">user</span> = user; <span class="hljs-comment">// 保存解析後的用戶信息</span>
    <span class="hljs-title function_">next</span>(); <span class="hljs-comment">// 通過驗證，繼續執行後續的路由</span>
  &#125;);
&#125;
</code></pre>
<h3 id="6-建立-express-後端-api"><a class="markdownIt-Anchor" href="#6-建立-express-後端-api"></a> 6. 建立 Express 後端 API</h3>
<p>設計 RESTful API，例如用於管理用戶的 CRUD 功能：</p>
<pre class="highlight"><code class="js"><span class="hljs-keyword">const</span> router = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;express&quot;</span>).<span class="hljs-title class_">Router</span>();
<span class="hljs-keyword">const</span> <span class="hljs-title class_">User</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;../model&quot;</span>).<span class="hljs-property">user</span>;
<span class="hljs-keyword">const</span> bcrypt = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;bcrypt&quot;</span>); <span class="hljs-comment">//用於加密用戶訊息 ex.password</span>

<span class="hljs-keyword">const</span> registerValidation = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;../validation&quot;</span>).<span class="hljs-property">registorValidation</span>;
<span class="hljs-keyword">const</span> loginValidation = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;../validation&quot;</span>).<span class="hljs-property">loginValidation</span>;
<span class="hljs-keyword">const</span> editorValidation = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;../validation&quot;</span>).<span class="hljs-property">editorValidation</span>;

<span class="hljs-comment">// 建立使用者</span>
router.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/register&quot;</span>, <span class="hljs-title function_">async</span> (req, res) =&gt; &#123;
  <span class="hljs-keyword">let</span> &#123; username, email, password, role &#125; = req.<span class="hljs-property">body</span>;
  <span class="hljs-keyword">let</span> &#123; error &#125; = <span class="hljs-title function_">registerValidation</span>(req.<span class="hljs-property">body</span>); <span class="hljs-comment">//確認數據是否符合規定</span>
  <span class="hljs-keyword">if</span> (error) &#123;
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">send</span>(error.<span class="hljs-property">details</span>[<span class="hljs-number">0</span>].<span class="hljs-property">message</span>);
  &#125;
  <span class="hljs-keyword">const</span> emailExist = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findOne</span>(&#123; email &#125;).<span class="hljs-title function_">exec</span>();
  <span class="hljs-keyword">if</span> (emailExist) &#123;
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;該信箱已被註册，請更换別的信箱。&quot;</span>);
  &#125;
  <span class="hljs-keyword">try</span> &#123;
    <span class="hljs-keyword">let</span> newUser = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(&#123; username, email, password, role &#125;);
    <span class="hljs-keyword">await</span> newUser.<span class="hljs-title function_">save</span>();
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">send</span>(&#123;
      <span class="hljs-attr">msg</span>: <span class="hljs-string">&quot;使用者成功儲存&quot;</span>,
      <span class="hljs-attr">user</span>: &#123;
        <span class="hljs-attr">id</span>: newUser.<span class="hljs-property">_id</span>,
        <span class="hljs-attr">username</span>: newUser.<span class="hljs-property">username</span>,
        <span class="hljs-attr">email</span>: newUser.<span class="hljs-property">email</span>,
        <span class="hljs-attr">password</span>: newUser.<span class="hljs-property">password</span>,
        <span class="hljs-attr">role</span>: newUser.<span class="hljs-property">role</span>,
      &#125;,
    &#125;);
  &#125; <span class="hljs-keyword">catch</span> (e) &#123;
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;無法儲存使用者&quot;</span>);
  &#125;
&#125;);

<span class="hljs-comment">//用戶登入</span>
router.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/login&quot;</span>, <span class="hljs-title function_">async</span> (req, res) =&gt; &#123;
  <span class="hljs-keyword">let</span> &#123; email, password &#125; = req.<span class="hljs-property">body</span>;
  <span class="hljs-keyword">let</span> &#123; error &#125; = <span class="hljs-title function_">loginValidation</span>(req.<span class="hljs-property">body</span>);
  <span class="hljs-keyword">if</span> (error) &#123;
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">send</span>(error.<span class="hljs-property">details</span>[<span class="hljs-number">0</span>].<span class="hljs-property">message</span>);
  &#125;
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">FUser</span> = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findOne</span>(&#123; email &#125;).<span class="hljs-title function_">exec</span>();
  <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">FUser</span>) &#123;
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;找不到此用戶，請確認信箱是否正確。&quot;</span>);
  &#125;
  <span class="hljs-title class_">FUser</span>.<span class="hljs-title function_">comparePassword</span>(password, <span class="hljs-function">(<span class="hljs-params">err, isMatch</span>) =&gt;</span> &#123;
    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">send</span>(err);
    <span class="hljs-keyword">if</span> (isMatch) &#123;
      <span class="hljs-keyword">const</span> tokenObj = &#123; <span class="hljs-attr">_id</span>: <span class="hljs-title class_">FUser</span>.<span class="hljs-property">_id</span>, <span class="hljs-attr">email</span>: <span class="hljs-title class_">FUser</span>.<span class="hljs-property">email</span> &#125;;
      <span class="hljs-keyword">const</span> token = <span class="hljs-variable constant_">JWT</span>.<span class="hljs-title function_">sign</span>(tokenObj, process.<span class="hljs-property">env</span>.<span class="hljs-property">PASSPORT_SECRET</span>);
      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">send</span>(&#123;
        <span class="hljs-attr">msg</span>: <span class="hljs-string">&quot;成功登入&quot;</span>,
        <span class="hljs-attr">token</span>: <span class="hljs-string">&quot;JWT &quot;</span> + token,
        <span class="hljs-attr">user</span>: <span class="hljs-title class_">FUser</span>,
      &#125;);
    &#125; <span class="hljs-keyword">else</span> &#123;
      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">401</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;密碼錯誤&quot;</span>);
    &#125;
  &#125;);
&#125;);

<span class="hljs-comment">//用戶資料修改</span>
router.<span class="hljs-title function_">patch</span>(<span class="hljs-string">&quot;/:_id&quot;</span>, authenticateToken, <span class="hljs-title function_">async</span> (req, res) =&gt; &#123;
  <span class="hljs-keyword">let</span> &#123; _id &#125; = req.<span class="hljs-property">params</span>;

  <span class="hljs-comment">// 驗證請求數據</span>
  <span class="hljs-keyword">let</span> &#123; error &#125; = <span class="hljs-title function_">editorValidation</span>(req.<span class="hljs-property">body</span>);
  <span class="hljs-keyword">if</span> (error) &#123;
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">send</span>(&#123; <span class="hljs-attr">error</span>: error.<span class="hljs-property">details</span>[<span class="hljs-number">0</span>].<span class="hljs-property">message</span> &#125;); <span class="hljs-comment">// 返回具體錯誤信息</span>
  &#125;

  <span class="hljs-keyword">try</span> &#123;
    <span class="hljs-comment">// 查找用戶</span>
    <span class="hljs-keyword">let</span> <span class="hljs-title class_">Uf</span> = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findById</span>(_id).<span class="hljs-title function_">exec</span>();
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Uf</span>) &#123;
      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">404</span>).<span class="hljs-title function_">send</span>(&#123; <span class="hljs-attr">error</span>: <span class="hljs-string">&quot;找不到此用戶&quot;</span> &#125;); <span class="hljs-comment">// 用戶未找到</span>
    &#125;

    <span class="hljs-comment">// 驗證當前用戶是否與要修改的用戶相同</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Uf</span>.<span class="hljs-property">_id</span>.<span class="hljs-title function_">toString</span>() === req.<span class="hljs-property">user</span>.<span class="hljs-property">_id</span>.<span class="hljs-title function_">toString</span>()) &#123;
      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(req.<span class="hljs-property">body</span>).<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) &#123;
        <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">send</span>(&#123; <span class="hljs-attr">error</span>: <span class="hljs-string">&quot;沒有提供更新資料&quot;</span> &#125;);
      &#125;

      <span class="hljs-keyword">let</span> updatedData = req.<span class="hljs-property">body</span>;

      <span class="hljs-comment">// 如果有提供密碼，則進行加密處理</span>
      <span class="hljs-keyword">if</span> (updatedData.<span class="hljs-property">password</span>) &#123;
        <span class="hljs-keyword">const</span> salt = <span class="hljs-keyword">await</span> bcrypt.<span class="hljs-title function_">genSalt</span>(<span class="hljs-number">10</span>); <span class="hljs-comment">// 生成salt</span>
        updatedData.<span class="hljs-property">password</span> = <span class="hljs-keyword">await</span> bcrypt.<span class="hljs-title function_">hash</span>(updatedData.<span class="hljs-property">password</span>, salt); <span class="hljs-comment">// 使用salt加密密碼</span>
      &#125;

      <span class="hljs-comment">// 更新用戶資料</span>
      <span class="hljs-keyword">const</span> updatedUser = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findByIdAndUpdate</span>(_id, updatedData, &#123;
        <span class="hljs-attr">new</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">runValidators</span>: <span class="hljs-literal">true</span>,
      &#125;);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(updatedUser);

      <span class="hljs-keyword">if</span> (!updatedUser) &#123;
        <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">send</span>(&#123; <span class="hljs-attr">error</span>: <span class="hljs-string">&quot;更新失敗&quot;</span> &#125;);
      &#125;

      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">send</span>(&#123; <span class="hljs-attr">msg</span>: <span class="hljs-string">&quot;資料被更新&quot;</span>, <span class="hljs-attr">user</span>: updatedUser &#125;);
    &#125; <span class="hljs-keyword">else</span> &#123;
      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">403</span>).<span class="hljs-title function_">send</span>(&#123; <span class="hljs-attr">error</span>: <span class="hljs-string">&quot;您無權更改此資料&quot;</span> &#125;); <span class="hljs-comment">// 權限錯誤</span>
    &#125;
  &#125; <span class="hljs-keyword">catch</span> (e) &#123;
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">send</span>(&#123; <span class="hljs-attr">error</span>: e.<span class="hljs-property">message</span> &#125;); <span class="hljs-comment">// 伺服器錯誤</span>
  &#125;
&#125;);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = router;
</code></pre>

    </div>
    
    
    
    
    
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2024 - 2024 HenRsの小窩
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;HenRs
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js" defer></script>
    
    




    
    <canvas
        id="fireworks"
        style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 32767"
    ></canvas>
    <script src="https://s4.zstatic.net/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="/js/fireworks.min.js" defer></script>
    <script src="/js/pagenation.min.js" defer></script>
</body>
</html>